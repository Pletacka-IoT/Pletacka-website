!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).naja=e()}(this,(function(){"use strict";var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};!function(){function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function i(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}function r(t){return(r=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function o(t,e){return(o=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function s(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function a(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?s(t):e}function l(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,i=r(t);if(e){var o=r(this).constructor;n=Reflect.construct(i,arguments,o)}else n=i.apply(this,arguments);return a(this,n)}}function c(t,e,n){return(c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var i=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=r(t)););return t}(t,e);if(i){var o=Object.getOwnPropertyDescriptor(i,e);return o.get?o.get.call(n):o.value}})(t,e,n||t)}var u=function(){function t(){e(this,t),Object.defineProperty(this,"listeners",{value:{},writable:!0,configurable:!0})}return i(t,[{key:"addEventListener",value:function(t,e){t in this.listeners||(this.listeners[t]=[]),this.listeners[t].push(e)}},{key:"removeEventListener",value:function(t,e){if(t in this.listeners)for(var n=this.listeners[t],i=0,r=n.length;i<r;i++)if(n[i]===e)return void n.splice(i,1)}},{key:"dispatchEvent",value:function(t){var e=this;if(t.type in this.listeners){for(var n=function(n){setTimeout((function(){return n.call(e,t)}))},i=this.listeners[t.type],r=0,o=i.length;r<o;r++)n(i[r]);return!t.defaultPrevented}}}]),t}(),d=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&o(t,e)}(a,t);var n=l(a);function a(){var t;return e(this,a),(t=n.call(this)).listeners||u.call(s(t)),Object.defineProperty(s(t),"aborted",{value:!1,writable:!0,configurable:!0}),Object.defineProperty(s(t),"onabort",{value:null,writable:!0,configurable:!0}),t}return i(a,[{key:"toString",value:function(){return"[object AbortSignal]"}},{key:"dispatchEvent",value:function(t){"abort"===t.type&&(this.aborted=!0,"function"==typeof this.onabort&&this.onabort.call(this,t)),c(r(a.prototype),"dispatchEvent",this).call(this,t)}}]),a}(u),p=function(){function t(){e(this,t),Object.defineProperty(this,"signal",{value:new d,writable:!0,configurable:!0})}return i(t,[{key:"abort",value:function(){var t;try{t=new Event("abort")}catch(e){"undefined"!=typeof document?document.createEvent?(t=document.createEvent("Event")).initEvent("abort",!1,!1):(t=document.createEventObject()).type="abort":t={type:"abort",bubbles:!1,cancelable:!1}}this.signal.dispatchEvent(t)}},{key:"toString",value:function(){return"[object AbortController]"}}]),t}();function h(t){return t.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log("__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill"),!0):"function"==typeof t.Request&&!t.Request.prototype.hasOwnProperty("signal")||!t.AbortController}"undefined"!=typeof Symbol&&Symbol.toStringTag&&(p.prototype[Symbol.toStringTag]="AbortController",d.prototype[Symbol.toStringTag]="AbortSignal"),function(t){if(h(t))if(t.fetch){var e=function(t){"function"==typeof t&&(t={fetch:t});var e=t,n=e.fetch,i=e.Request,r=void 0===i?n.Request:i,o=e.AbortController,s=e.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL,a=void 0!==s&&s;if(!h({fetch:n,Request:r,AbortController:o,__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL:a}))return{fetch:n,Request:l};var l=r;(l&&!l.prototype.hasOwnProperty("signal")||a)&&((l=function(t,e){var n;e&&e.signal&&(n=e.signal,delete e.signal);var i=new r(t,e);return n&&Object.defineProperty(i,"signal",{writable:!1,enumerable:!1,configurable:!0,value:n}),i}).prototype=r.prototype);var c=n;return{fetch:function(t,e){var n=l&&l.prototype.isPrototypeOf(t)?t.signal:e?e.signal:void 0;if(n){var i;try{i=new DOMException("Aborted","AbortError")}catch(t){(i=new Error("Aborted")).name="AbortError"}if(n.aborted)return Promise.reject(i);var r=new Promise((function(t,e){n.addEventListener("abort",(function(){return e(i)}),{once:!0})}));return e&&e.signal&&delete e.signal,Promise.race([r,c(t,e)])}return c(t,e)},Request:l}}(t),n=e.fetch,i=e.Request;t.fetch=n,t.Request=i,Object.defineProperty(t,"AbortController",{writable:!0,enumerable:!1,configurable:!0,value:p}),Object.defineProperty(t,"AbortSignal",{writable:!0,enumerable:!1,configurable:!0,value:d})}else console.warn("fetch() is not available, cannot install abortcontroller-polyfill")}("undefined"!=typeof self?self:t)}();const e=new WeakMap,n=new WeakMap;function i(t){const n=e.get(t);return console.assert(null!=n,"'this' is expected an Event object, but got",t),n}function r(t){null==t.passiveListener?t.event.cancelable&&(t.canceled=!0,"function"==typeof t.event.preventDefault&&t.event.preventDefault()):"undefined"!=typeof console&&"function"==typeof console.error&&console.error("Unable to preventDefault inside passive event listener invocation.",t.passiveListener)}function o(t,n){e.set(this,{eventTarget:t,event:n,eventPhase:2,currentTarget:t,canceled:!1,stopped:!1,immediateStopped:!1,passiveListener:null,timeStamp:n.timeStamp||Date.now()}),Object.defineProperty(this,"isTrusted",{value:!1,enumerable:!0});const i=Object.keys(n);for(let t=0;t<i.length;++t){const e=i[t];e in this||Object.defineProperty(this,e,s(e))}}function s(t){return{get(){return i(this).event[t]},set(e){i(this).event[t]=e},configurable:!0,enumerable:!0}}function a(t){return{value(){const e=i(this).event;return e[t].apply(e,arguments)},configurable:!0,enumerable:!0}}function l(t){if(null==t||t===Object.prototype)return o;let e=n.get(t);return null==e&&(e=function(t,e){const n=Object.keys(e);if(0===n.length)return t;function i(e,n){t.call(this,e,n)}i.prototype=Object.create(t.prototype,{constructor:{value:i,configurable:!0,writable:!0}});for(let r=0;r<n.length;++r){const o=n[r];if(!(o in t.prototype)){const t="function"==typeof Object.getOwnPropertyDescriptor(e,o).value;Object.defineProperty(i.prototype,o,t?a(o):s(o))}}return i}(l(Object.getPrototypeOf(t)),t),n.set(t,e)),e}function c(t){return i(t).immediateStopped}function u(t,e){i(t).passiveListener=e}o.prototype={get type(){return i(this).event.type},get target(){return i(this).eventTarget},get currentTarget(){return i(this).currentTarget},composedPath(){const t=i(this).currentTarget;return null==t?[]:[t]},get NONE(){return 0},get CAPTURING_PHASE(){return 1},get AT_TARGET(){return 2},get BUBBLING_PHASE(){return 3},get eventPhase(){return i(this).eventPhase},stopPropagation(){const t=i(this);t.stopped=!0,"function"==typeof t.event.stopPropagation&&t.event.stopPropagation()},stopImmediatePropagation(){const t=i(this);t.stopped=!0,t.immediateStopped=!0,"function"==typeof t.event.stopImmediatePropagation&&t.event.stopImmediatePropagation()},get bubbles(){return Boolean(i(this).event.bubbles)},get cancelable(){return Boolean(i(this).event.cancelable)},preventDefault(){r(i(this))},get defaultPrevented(){return i(this).canceled},get composed(){return Boolean(i(this).event.composed)},get timeStamp(){return i(this).timeStamp},get srcElement(){return i(this).eventTarget},get cancelBubble(){return i(this).stopped},set cancelBubble(t){if(!t)return;const e=i(this);e.stopped=!0,"boolean"==typeof e.event.cancelBubble&&(e.event.cancelBubble=!0)},get returnValue(){return!i(this).canceled},set returnValue(t){t||r(i(this))},initEvent(){}},Object.defineProperty(o.prototype,"constructor",{value:o,configurable:!0,writable:!0}),"undefined"!=typeof window&&void 0!==window.Event&&(Object.setPrototypeOf(o.prototype,window.Event.prototype),n.set(window.Event.prototype,o));const d=new WeakMap;function p(t){return null!==t&&"object"==typeof t}function h(t){const e=d.get(t);if(null==e)throw new TypeError("'this' is expected an EventTarget object, but got another value.");return e}function f(t,e){Object.defineProperty(t,"on"+e,function(t){return{get(){let e=h(this).get(t);for(;null!=e;){if(3===e.listenerType)return e.listener;e=e.next}return null},set(e){"function"==typeof e||p(e)||(e=null);const n=h(this);let i=null,r=n.get(t);for(;null!=r;)3===r.listenerType?null!==i?i.next=r.next:null!==r.next?n.set(t,r.next):n.delete(t):i=r,r=r.next;if(null!==e){const r={listener:e,listenerType:3,passive:!1,once:!1,next:null};null===i?n.set(t,r):i.next=r}},configurable:!0,enumerable:!0}}(e))}function b(t){function e(){v.call(this)}e.prototype=Object.create(v.prototype,{constructor:{value:e,configurable:!0,writable:!0}});for(let n=0;n<t.length;++n)f(e.prototype,t[n]);return e}function v(){if(!(this instanceof v)){if(1===arguments.length&&Array.isArray(arguments[0]))return b(arguments[0]);if(arguments.length>0){const t=new Array(arguments.length);for(let e=0;e<arguments.length;++e)t[e]=arguments[e];return b(t)}throw new TypeError("Cannot call a class as a function")}d.set(this,new Map)}v.prototype={addEventListener(t,e,n){if(null==e)return;if("function"!=typeof e&&!p(e))throw new TypeError("'listener' should be a function or an object.");const i=h(this),r=p(n),o=(r?Boolean(n.capture):Boolean(n))?1:2,s={listener:e,listenerType:o,passive:r&&Boolean(n.passive),once:r&&Boolean(n.once),next:null};let a=i.get(t);if(void 0===a)return void i.set(t,s);let l=null;for(;null!=a;){if(a.listener===e&&a.listenerType===o)return;l=a,a=a.next}l.next=s},removeEventListener(t,e,n){if(null==e)return;const i=h(this),r=(p(n)?Boolean(n.capture):Boolean(n))?1:2;let o=null,s=i.get(t);for(;null!=s;){if(s.listener===e&&s.listenerType===r)return void(null!==o?o.next=s.next:null!==s.next?i.set(t,s.next):i.delete(t));o=s,s=s.next}},dispatchEvent(t){if(null==t||"string"!=typeof t.type)throw new TypeError('"event.type" should be a string.');const e=h(this),n=t.type;let r=e.get(n);if(null==r)return!0;const o=function(t,e){return new(l(Object.getPrototypeOf(e)))(t,e)}(this,t);let s=null;for(;null!=r;){if(r.once?null!==s?s.next=r.next:null!==r.next?e.set(n,r.next):e.delete(n):s=r,u(o,r.passive?r.listener:null),"function"==typeof r.listener)try{r.listener.call(this,o)}catch(t){"undefined"!=typeof console&&"function"==typeof console.error&&console.error(t)}else 3!==r.listenerType&&"function"==typeof r.listener.handleEvent&&r.listener.handleEvent(o);if(c(o))break;r=r.next}return u(o,null),function(t,e){i(t).eventPhase=e}(o,0),function(t,e){i(t).currentTarget=e}(o,null),!o.defaultPrevented}},Object.defineProperty(v.prototype,"constructor",{value:v,configurable:!0,writable:!0}),"undefined"!=typeof window&&void 0!==window.EventTarget&&Object.setPrototypeOf(v.prototype,window.EventTarget.prototype);try{new window.EventTarget}catch(t){window.EventTarget=v}function y(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}class m extends EventTarget{constructor(t){super(),y(this,"selector",".ajax"),y(this,"allowedOrigins",[window.location.origin]),y(this,"handler",this.handleUI.bind(this)),this.naja=t,t.addEventListener("init",this.initialize.bind(this))}initialize(){this.bindUI(window.document.body),this.naja.snippetHandler.addEventListener("afterUpdate",t=>{const{snippet:e}=t.detail;this.bindUI(e)})}bindUI(t){const e=["a"+this.selector,'input[type="submit"]'+this.selector,'input[type="image"]'+this.selector,'button[type="submit"]'+this.selector,`form${this.selector} input[type="submit"]`,`form${this.selector} input[type="image"]`,`form${this.selector} button[type="submit"]`].join(", "),n=t=>{t.removeEventListener("click",this.handler),t.addEventListener("click",this.handler)},i=t.querySelectorAll(e);for(let t=0;t<i.length;t++)n(i.item(t));t.matches(e)&&n(t);const r=t=>{t.removeEventListener("submit",this.handler),t.addEventListener("submit",this.handler)};t.matches("form"+this.selector)&&r(t);const o=t.querySelectorAll("form"+this.selector);for(let t=0;t<o.length;t++)r(o.item(t))}handleUI(t){if(t.altKey||t.ctrlKey||t.shiftKey||t.metaKey||t.button)return;const e=t.currentTarget,n={};"submit"===t.type?this.submitForm(e,n,t):"click"===t.type&&this.clickElement(e,n,t)}clickElement(t,e={},n){let i,r,o;if(this.dispatchEvent(new CustomEvent("interaction",{cancelable:!0,detail:{element:t,originalEvent:n,options:e}}))){if("A"===t.tagName)i="GET",r=t.href,o=null;else if("INPUT"===t.tagName||"BUTTON"===t.tagName){const{form:e}=t;if(i=t.hasAttribute("formmethod")?t.getAttribute("formmethod").toUpperCase():e.hasAttribute("method")?e.getAttribute("method").toUpperCase():"GET",r=t.getAttribute("formaction")||e.getAttribute("action")||window.location.pathname+window.location.search,o=new FormData(e),"submit"===t.type||"BUTTON"===t.tagName)o.append(t.name,t.value||"");else if("image"===t.type){const e=t.getBoundingClientRect();o.append(t.name+".x",Math.max(0,Math.floor(n.pageX-e.left))),o.append(t.name+".y",Math.max(0,Math.floor(n.pageY-e.top)))}}this.isUrlAllowed(r)&&(n&&n.preventDefault(),this.naja.makeRequest(i,r,o,e))}else n&&n.preventDefault()}submitForm(t,e={},n){if(!this.dispatchEvent(new CustomEvent("interaction",{cancelable:!0,detail:{element:t,originalEvent:n,options:e}})))return void(n&&n.preventDefault());const i=t.hasAttribute("method")?t.getAttribute("method").toUpperCase():"GET",r=t.getAttribute("action")||window.location.pathname+window.location.search,o=new FormData(t);this.isUrlAllowed(r)&&(n&&n.preventDefault(),this.naja.makeRequest(i,r,o,e))}isUrlAllowed(t){return!/^(?!https?)[^:/?#]+:/i.test(t)&&(!/^https?/i.test(t)||this.allowedOrigins.some(e=>new RegExp("^"+e,"i").test(t)))}}class g{constructor(t){y(this,"netteForms",void 0),this.naja=t,t.addEventListener("init",this.initialize.bind(this)),t.uiHandler.addEventListener("interaction",this.processForm.bind(this))}initialize(){this.initForms(window.document.body),this.naja.snippetHandler.addEventListener("afterUpdate",t=>{const{snippet:e}=t.detail;this.initForms(e)})}initForms(t){const e=this.netteForms||window.Nette;if(e){"form"===t.tagName&&e.initForm(t);const n=t.querySelectorAll("form");for(let t=0;t<n.length;t++)e.initForm(n.item(t))}}processForm(t){const{element:e,originalEvent:n}=t.detail;e.form&&(e.form["nette-submittedBy"]=e);const i=this.netteForms||window.Nette;"FORM"!==e.tagName&&!e.form||!i||i.validateForm(e)||(n&&(n.stopImmediatePropagation(),n.preventDefault()),t.preventDefault())}}class w extends EventTarget{constructor(t){super(),this.naja=t,t.uiHandler.addEventListener("interaction",t=>{var e;const{element:n,options:i}=t.detail;if(n&&(n.hasAttribute("data-naja-force-redirect")||(null===(e=n.form)||void 0===e?void 0:e.hasAttribute("data-naja-force-redirect")))){var r,o;const t=null!==(r=n.getAttribute("data-naja-force-redirect"))&&void 0!==r?r:null===(o=n.form)||void 0===o?void 0:o.getAttribute("data-naja-force-redirect");i.forceRedirect="off"!==t}}),t.addEventListener("success",t=>{const{payload:e,options:n}=t.detail;e.redirect&&(this.makeRedirect(e.redirect,n.forceRedirect,n),t.stopImmediatePropagation())}),this.locationAdapter={assign:t=>window.location.assign(t)}}makeRedirect(t,e,n={}){t instanceof URL&&(t=t.href);let i=e||!this.naja.uiHandler.isUrlAllowed(t);this.dispatchEvent(new CustomEvent("redirect",{cancelable:!0,detail:{url:t,isHardRedirect:i,setHardRedirect(t){i=!!t},options:n}}))&&(i?this.locationAdapter.assign(t):this.naja.makeRequest("GET",t,null,n))}}class E extends EventTarget{constructor(t){super(),y(this,"op",{replace:(t,e)=>{t.innerHTML=e},prepend:(t,e)=>t.insertAdjacentHTML("afterbegin",e),append:(t,e)=>t.insertAdjacentHTML("beforeend",e)}),t.addEventListener("success",t=>{const{options:e,payload:n}=t.detail;n.snippets&&this.updateSnippets(n.snippets,!1,e)})}updateSnippets(t,e=!1,n={}){Object.keys(t).forEach(i=>{const r=document.getElementById(i);r&&this.updateSnippet(r,t[i],e,n)})}updateSnippet(t,e,n,i){let r=this.op.replace;!t.hasAttribute("data-naja-snippet-prepend")&&!t.hasAttribute("data-ajax-prepend")||n?!t.hasAttribute("data-naja-snippet-append")&&!t.hasAttribute("data-ajax-append")||n||(r=this.op.append):r=this.op.prepend;this.dispatchEvent(new CustomEvent("beforeUpdate",{cancelable:!0,detail:{snippet:t,content:e,fromCache:n,operation:r,changeOperation(t){r=t},options:i}}))&&("title"===t.tagName.toLowerCase()?document.title=e:r(t,e),this.dispatchEvent(new CustomEvent("afterUpdate",{cancelable:!0,detail:{snippet:t,content:e,fromCache:n,operation:r,options:i}})))}}class j{constructor(t){y(this,"href",null),y(this,"uiCache",!0),this.naja=t,t.addEventListener("init",this.initialize.bind(this)),t.addEventListener("before",this.saveUrl.bind(this)),t.addEventListener("success",this.pushNewState.bind(this)),t.uiHandler.addEventListener("interaction",this.configureMode.bind(this)),this.popStateHandler=this.handlePopState.bind(this),this.historyAdapter={replaceState:(t,e,n)=>window.history.replaceState(t,e,n),pushState:(t,e,n)=>window.history.pushState(t,e,n)}}initialize(t){const{defaultOptions:e}=t.detail;"historyUiCache"in e&&(this.uiCache=e.historyUiCache),window.addEventListener("popstate",this.popStateHandler),this.historyAdapter.replaceState(this.buildState(window.location.href,this.uiCache),window.document.title,window.location.href)}handlePopState(t){t.state&&(t.state.ui?(this.handleSnippets(t.state.ui),this.handleTitle(t.state.title)):!1===t.state.ui&&this.naja.makeRequest("GET",t.state.href,null,{history:!1,historyUiCache:!1}))}saveUrl(t){const{url:e}=t.detail;this.href=e}configureMode(t){var e,n;const{element:i,options:r}=t.detail;if(i){if(i.hasAttribute("data-naja-history")||(null===(e=i.form)||void 0===e?void 0:e.hasAttribute("data-naja-history"))){var o,s;const t=null!==(o=i.getAttribute("data-naja-history"))&&void 0!==o?o:null===(s=i.form)||void 0===s?void 0:s.getAttribute("data-naja-history");r.history=this.constructor.normalizeMode(t)}if(i.hasAttribute("data-naja-history-cache")||(null===(n=i.form)||void 0===n?void 0:n.hasAttribute("data-naja-history-nocache"))){var a,l;const t=null!==(a=i.getAttribute("data-naja-history-cache"))&&void 0!==a?a:null===(l=i.form)||void 0===l?void 0:l.getAttribute("data-naja-history-cache");r.historyUiCache="off"!==t}}}static normalizeMode(t){return"off"!==t&&!1!==t&&("replace"!==t||"replace")}pushNewState(t){const{payload:e,options:n}=t.detail,i=this.constructor.normalizeMode(n.history);if(!1===i)return;e.postGet&&e.url&&(this.href=e.url);const r="replace"===i?"replaceState":"pushState",o=!0===n.historyUiCache||!1!==n.historyUiCache&&this.uiCache;this.historyAdapter[r](this.buildState(this.href,o),window.document.title,this.href),this.href=null}buildState(t,e){const n={href:t};return e?(n.title=window.document.title,n.ui=this.findSnippets()):n.ui=!1,n}findSnippets(){const t={},e=window.document.querySelectorAll('[id^="snippet-"]');for(let n=0;n<e.length;n++){const i=e.item(n);i.hasAttribute("data-naja-history-nocache")||i.hasAttribute("data-history-nocache")||(t[i.id]=i.innerHTML)}return t}handleSnippets(t){this.naja.snippetHandler.updateSnippets(t,!0),this.naja.scriptLoader.loadScripts(t)}handleTitle(t){window.document.title=t}}class A{constructor(t){t.addEventListener("success",t=>{const{payload:e}=t.detail;e.snippets&&this.loadScripts(e.snippets)})}loadScripts(t){Object.keys(t).forEach(e=>{const n=t[e];if(!/<script/i.test(n))return;const i=window.document.createElement("div");i.innerHTML=n;const r=i.querySelectorAll("script");for(let t=0;t<r.length;t++){const e=r.item(t),n=window.document.createElement("script");if(n.innerHTML=e.innerHTML,e.hasAttributes()){const t=e.attributes;for(let e=0;e<t.length;e++){n[t[e].name]=t[e].value}}window.document.head.appendChild(n).parentNode.removeChild(n)}})}}class O extends EventTarget{constructor(t,e,n,i,r,o){super(),y(this,"VERSION",2),y(this,"initialized",!1),y(this,"uiHandler",null),y(this,"redirectHandler",null),y(this,"snippetHandler",null),y(this,"formsHandler",null),y(this,"historyHandler",null),y(this,"scriptLoader",null),y(this,"extensions",[]),y(this,"defaultOptions",{}),this.uiHandler=t?new t(this):new m(this),this.redirectHandler=e?new e(this):new w(this),this.snippetHandler=n?new n(this):new E(this),this.formsHandler=i?new i(this):new g(this),this.historyHandler=r?new r(this):new j(this),this.scriptLoader=o?new o(this):new A(this)}registerExtension(t){this.initialized&&t.initialize(this),this.extensions.push(t)}initialize(t={}){if(this.initialized)throw new Error("Cannot initialize Naja, it is already initialized.");this.defaultOptions=t,this.extensions.forEach(t=>t.initialize(this)),this.dispatchEvent(new CustomEvent("init",{detail:{defaultOptions:t}})),this.initialized=!0}async makeRequest(t,e,n=null,i={}){if(e instanceof URL&&(e=e.href),i={...this.defaultOptions,...i,fetch:{...this.defaultOptions.fetch||{},...i.fetch||{}}},"GET"===t.toUpperCase()&&n instanceof FormData){const t=new URL(e,location.href);for(const[e,i]of n)t.searchParams.append(e,i);e=t.toString(),n=null}const r=new AbortController,o=new Request(e,{credentials:"same-origin",...i.fetch,method:t,headers:new Headers(i.fetch.headers||{}),body:null!==n&&Object.getPrototypeOf(n)===Object.prototype?new URLSearchParams(n):n,signal:r.signal});if(o.headers.set("X-Requested-With","XMLHttpRequest"),!this.dispatchEvent(new CustomEvent("before",{cancelable:!0,detail:{request:o,method:t,url:e,data:n,options:i}})))return{};const s=window.fetch(o);let a,l;this.dispatchEvent(new CustomEvent("start",{detail:{request:o,promise:s,abortController:r,options:i}}));try{if(a=await s,!a.ok)throw new L(a);l=await a.json()}catch(t){if("AbortError"===t.name)return this.dispatchEvent(new CustomEvent("abort",{detail:{request:o,error:t,options:i}})),this.dispatchEvent(new CustomEvent("complete",{detail:{request:o,response:a,payload:void 0,error:t,options:i}})),{};throw this.dispatchEvent(new CustomEvent("error",{detail:{request:o,response:a,error:t,options:i}})),this.dispatchEvent(new CustomEvent("complete",{detail:{request:o,response:a,payload:void 0,error:t,options:i}})),t}return this.dispatchEvent(new CustomEvent("success",{detail:{request:o,response:a,payload:l,options:i}})),this.dispatchEvent(new CustomEvent("complete",{detail:{request:o,response:a,payload:l,error:void 0,options:i}})),l}}class L extends Error{constructor(t){const e=`HTTP ${t.status}: ${t.statusText}`;super(e),this.name=this.constructor.name,this.stack=new Error(e).stack,this.response=t}}const T=new O;return T.registerExtension(new class{constructor(){y(this,"abortable",!0),y(this,"abortController",null)}initialize(t){t.uiHandler.addEventListener("interaction",this.checkAbortable.bind(this)),t.addEventListener("init",this.onInitialize.bind(this)),t.addEventListener("before",this.checkAbortable.bind(this)),t.addEventListener("start",this.saveAbortController.bind(this)),t.addEventListener("complete",this.clearAbortController.bind(this))}onInitialize(){document.addEventListener("keydown",t=>{null!==this.abortController&&("key"in t?"Escape"===t.key:27===t.keyCode)&&!(t.ctrlKey||t.shiftKey||t.altKey||t.metaKey)&&this.abortable&&(this.abortController.abort(),this.abortController=null)})}checkAbortable(t){var e,n;const{element:i,options:r}=t.detail;this.abortable=i?"off"!==(null!==(e=i.getAttribute("data-naja-abort"))&&void 0!==e?e:null===(n=i.form)||void 0===n?void 0:n.getAttribute("data-naja-abort")):!1!==r.abort,r.abort=this.abortable}saveAbortController(t){const{abortController:e}=t.detail;this.abortController=e}clearAbortController(){this.abortController=null,this.abortable=!0}}),T.registerExtension(new class{constructor(){y(this,"abortControllers",new Map)}initialize(t){t.uiHandler.addEventListener("interaction",this.checkUniqueness.bind(this)),t.addEventListener("start",this.abortPreviousRequest.bind(this)),t.addEventListener("complete",this.clearRequest.bind(this))}checkUniqueness(t){var e,n;const{element:i,options:r}=t.detail,o=null!==(e=i.getAttribute("data-naja-unique"))&&void 0!==e?e:null===(n=i.form)||void 0===n?void 0:n.getAttribute("data-naja-unique");r.unique="off"!==o&&(null!=o?o:"default")}abortPreviousRequest(t){const{abortController:e,options:n}=t.detail;var i;!1!==n.unique&&(null===(i=this.abortControllers.get(n.unique))||void 0===i||i.abort(),this.abortControllers.set(n.unique,e))}clearRequest(t){const{request:e,options:n}=t.detail;e.signal.aborted||this.abortControllers.delete(n.unique)}}),T.Naja=O,T.HttpError=L,T}));
//# sourceMappingURL=Naja-2-0-1.min.js.map
